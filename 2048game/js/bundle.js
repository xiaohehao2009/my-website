function GameManager(t,e,i,n){this.size=t,this.inputManager=new e,this.storageManager=new n,this.actuator=new i,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.restart.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this)),this.setup()}function Grid(t,e){this.size=t,this.cells=e?this.fromState(e):this.empty()}function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container"),this.scoreContainer=document.querySelector(".score-container"),this.bestContainer=document.querySelector(".best-container"),this.messageContainer=document.querySelector(".game-message"),this.score=0}function KeyboardInputManager(){this.events={},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend"),this.listen()}function LocalStorageManager(){this.bestScoreKey="bestScore",this.gameStateKey="gameState";var t=this.localStorageSupported();this.storage=t?window.localStorage:window.fakeStorage}function Tile(t,e){this.x=t.x,this.y=t.y,this.value=e||2,this.previousPosition=null,this.mergedFrom=null}!function(){for(var o=0,t=["webkit","moz"],e=0;e<t.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"]||window[t[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var e=(new Date).getTime(),i=Math.max(0,16-(e-o)),n=window.setTimeout(function(){t(e+i)},i);return o=e+i,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),window.requestAnimationFrame(function(){window.game=new GameManager(4,KeyboardInputManager,HTMLActuator,LocalStorageManager)}),Function.prototype.bind=Function.prototype.bind||function(e){var i=this;return function(t){t instanceof Array||(t=[t]),i.apply(e,t)}},!function(){var n,i,t,e,o,a;function r(t){for(var e=(this.el=t).className.replace(/^\s+|\s+$/g,"").split(/\s+/),i=0;i<e.length;i++)n.call(this,e[i])}void 0===window.Element||"classList"in document.documentElement||(e=Array.prototype,n=e.push,i=e.splice,t=e.join,r.prototype={add:function(t){this.contains(t)||(n.call(this,t),this.el.className=this.toString())},contains:function(t){return-1!=this.el.className.indexOf(t)},item:function(t){return this[t]||null},remove:function(t){if(this.contains(t)){for(var e=0;e<this.length&&this[e]!=t;e++);i.call(this,e,1),this.el.className=this.toString()}},toString:function(){return t.call(this," ")},toggle:function(t){return this.contains(t)?this.remove(t):this.add(t),this.contains(t)}},window.DOMTokenList=r,e=HTMLElement.prototype,o="classList",a=function(){return new r(this)},Object.defineProperty?Object.defineProperty(e,o,{get:a}):e.__defineGetter__(o,a))}(),GameManager.startTiles=2,GameManager.randomTiles=1,GameManager.randomTile="Math.random() < 0.9 ? 2 : 4",GameManager.prototype.restart=function(){this.storageManager.clearGameState(),this.actuator.continueGame(),this.setup()},GameManager.prototype.keepPlaying=function(){this.keepPlaying=!0,this.actuator.continueGame()},GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying},GameManager.prototype.setup=function(){var t=this.storageManager.getGameState();t?(this.grid=new Grid(t.grid.size,t.grid.cells),this.score=t.score,this.over=t.over,this.won=t.won,this.keepPlaying=t.keepPlaying):(this.grid=new Grid(this.size),this.score=0,this.over=!1,this.won=!1,this.keepPlaying=!1,this.addStartTiles()),this.actuate()},GameManager.prototype.addStartTiles=function(){for(var t=0;t<GameManager.startTiles;t++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){var value,tile;this.grid.cellsAvailable()&&(value=eval(GameManager.randomTile),tile=new Tile(this.grid.randomAvailableCell(),value),this.grid.insertTile(tile))},GameManager.prototype.actuate=function(){this.storageManager.getBestScore()<this.score&&this.storageManager.setBestScore(this.score),this.over?this.storageManager.clearGameState():this.storageManager.setGameState(this.serialize()),this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),terminated:this.isGameTerminated()})},GameManager.prototype.serialize=function(){return{grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying}},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(t,e,i){i&&(i.mergedFrom=null,i.savePosition())})},GameManager.prototype.moveTile=function(t,e){this.grid.cells[t.x][t.y]=null,(this.grid.cells[e.x][e.y]=t).updatePosition(e)},GameManager.prototype.move=function(t){var o=this;if(!this.isGameTerminated()){var a,r,s=this.getVector(t),e=this.buildTraversals(s),l=!1;if(this.prepareTiles(),e.x.forEach(function(n){e.y.forEach(function(t){var e,i;a={x:n,y:t},(r=o.grid.cellContent(a))&&(t=o.findFarthestPosition(a,s),(e=o.grid.cellContent(t.next))&&e.value===r.value&&!e.mergedFrom?((i=new Tile(t.next,2*r.value)).mergedFrom=[r,e],o.grid.insertTile(i),o.grid.removeTile(r),r.updatePosition(t.next),o.score+=i.value,2048===i.value&&(o.won=!0)):o.moveTile(r,t.farthest),o.positionsEqual(a,r)||(l=!0))})}),l){for(var i=0;i<GameManager.randomTiles;i++)this.addRandomTile();this.movesAvailable()||(this.over=!0),this.actuate()}}},GameManager.prototype.getVector=function(t){return{0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}}[t]},GameManager.prototype.buildTraversals=function(t){for(var e={x:[],y:[]},i=0;i<this.size;i++)e.x.push(i),e.y.push(i);return 1===t.x&&(e.x=e.x.reverse()),1===t.y&&(e.y=e.y.reverse()),e},GameManager.prototype.findFarthestPosition=function(t,e){for(var i;t={x:(i=t).x+e.x,y:i.y+e.y},this.grid.withinBounds(t)&&this.grid.cellAvailable(t););return{farthest:i,next:t}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var t,e=0;e<this.size;e++)for(var i=0;i<this.size;i++)if(t=this.grid.cellContent({x:e,y:i}))for(var n=0;n<4;n++){var o=this.getVector(n),o={x:e+o.x,y:i+o.y},o=this.grid.cellContent(o);if(o&&o.value===t.value)return!0}return!1},GameManager.prototype.positionsEqual=function(t,e){return t.x===e.x&&t.y===e.y},Grid.prototype.empty=function(){for(var t=[],e=0;e<this.size;e++)for(var i=t[e]=[],n=0;n<this.size;n++)i.push(null);return t},Grid.prototype.fromState=function(t){for(var e=[],i=0;i<this.size;i++)for(var n=e[i]=[],o=0;o<this.size;o++){var a=t[i][o];n.push(a?new Tile(a.position,a.value):null)}return e},Grid.prototype.randomAvailableCell=function(){var t=this.availableCells();if(t.length)return t[Math.floor(Math.random()*t.length)]},Grid.prototype.availableCells=function(){var n=[];return this.eachCell(function(t,e,i){i||n.push({x:t,y:e})}),n},Grid.prototype.eachCell=function(t){for(var e=0;e<this.size;e++)for(var i=0;i<this.size;i++)t(e,i,this.cells[e][i])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(t){return!this.cellOccupied(t)},Grid.prototype.cellOccupied=function(t){return!!this.cellContent(t)},Grid.prototype.cellContent=function(t){return this.withinBounds(t)?this.cells[t.x][t.y]:null},Grid.prototype.insertTile=function(t){this.cells[t.x][t.y]=t},Grid.prototype.removeTile=function(t){this.cells[t.x][t.y]=null},Grid.prototype.withinBounds=function(t){return 0<=t.x&&t.x<this.size&&0<=t.y&&t.y<this.size},Grid.prototype.serialize=function(){for(var t=[],e=0;e<this.size;e++)for(var i=t[e]=[],n=0;n<this.size;n++)i.push(this.cells[e][n]?this.cells[e][n].serialize():null);return{size:this.size,cells:t}},HTMLActuator.prototype.actuate=function(t,e){var i=this;window.requestAnimationFrame(function(){i.clearContainer(i.tileContainer),t.cells.forEach(function(t){t.forEach(function(t){t&&i.addTile(t)})}),i.updateScore(e.score),i.updateBestScore(e.bestScore),e.terminated&&(e.over?i.message(!1):e.won&&i.message(!0))})},HTMLActuator.prototype.continueGame=function(){this.clearMessage()},HTMLActuator.prototype.clearContainer=function(t){for(;t.firstChild;)t.removeChild(t.firstChild)},HTMLActuator.prototype.addTile=function(t){var e=this,i=document.createElement("div"),n=document.createElement("div"),o=t.previousPosition||{x:t.x,y:t.y},o=this.positionClass(o),a=["tile","tile-"+t.value,o];2048<t.value&&a.push("tile-super"),this.applyClasses(i,a),n.classList.add("tile-inner"),n.textContent=t.value,t.previousPosition?window.requestAnimationFrame(function(){a[2]=e.positionClass({x:t.x,y:t.y}),e.applyClasses(i,a)}):t.mergedFrom?(a.push("tile-merged"),this.applyClasses(i,a),t.mergedFrom.forEach(function(t){e.addTile(t)})):(a.push("tile-new"),this.applyClasses(i,a)),i.appendChild(n),this.tileContainer.appendChild(i)},HTMLActuator.prototype.applyClasses=function(t,e){t.setAttribute("class",e.join(" "))},HTMLActuator.prototype.normalizePosition=function(t){return{x:t.x+1,y:t.y+1}},HTMLActuator.prototype.positionClass=function(t){return"tile-position-"+(t=this.normalizePosition(t)).x+"-"+t.y},HTMLActuator.prototype.updateScore=function(t){this.clearContainer(this.scoreContainer);var e=t-this.score;this.score=t,this.scoreContainer.textContent=this.score,0<e&&((t=document.createElement("div")).classList.add("score-addition"),t.textContent="+"+e,this.scoreContainer.appendChild(t))},HTMLActuator.prototype.updateBestScore=function(t){this.bestContainer.textContent=t},HTMLActuator.prototype.message=function(t){var e=t?"你赢了!":"你失败了";this.messageContainer.classList.add(t?"game-won":"game-over"),this.messageContainer.getElementsByTagName("p")[0].textContent=e},HTMLActuator.prototype.clearMessage=function(){this.messageContainer.classList.remove("game-won"),this.messageContainer.classList.remove("game-over")},KeyboardInputManager.prototype.on=function(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)},KeyboardInputManager.prototype.emit=function(t,e){t=this.events[t];t&&t.forEach(function(t){t(e)})},KeyboardInputManager.prototype.listen=function(){var o,a,r=this,n={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3},t=(document.addEventListener("keydown",function(t){var e=t.altKey||t.ctrlKey||t.metaKey||t.shiftKey,i=n[t.which];e||void 0!==i&&(t.preventDefault(),r.emit("move",i)),e||82!==t.which||r.restart.call(r,t)}),this.bindButtonPress(".retry-button",this.restart),this.bindButtonPress(".restart-button",this.restart),this.bindButtonPress(".keep-playing-button",this.keepPlaying),document.getElementsByClassName("game-container")[0]);t.addEventListener(this.eventTouchstart,function(t){!window.navigator.msPointerEnabled&&1<t.touches.length||1<t.targetTouches.length||(a=window.navigator.msPointerEnabled?(o=t.pageX,t.pageY):(o=t.touches[0].clientX,t.touches[0].clientY),t.preventDefault())}),t.addEventListener(this.eventTouchmove,function(t){t.preventDefault()}),t.addEventListener(this.eventTouchend,function(t){var e,i,n;!window.navigator.msPointerEnabled&&0<t.touches.length||0<t.targetTouches.length||(t=window.navigator.msPointerEnabled?(e=t.pageX,t.pageY):(e=t.changedTouches[0].clientX,t.changedTouches[0].clientY),e=e-o,i=Math.abs(e),t=t-a,n=Math.abs(t),10<Math.max(i,n)&&r.emit("move",n<i?0<e?1:3:0<t?2:0))})},KeyboardInputManager.prototype.restart=function(t){t.preventDefault(),this.emit("restart")},KeyboardInputManager.prototype.keepPlaying=function(t){t.preventDefault(),this.emit("keepPlaying")},KeyboardInputManager.prototype.bindButtonPress=function(t,e){t=document.querySelector(t);t.addEventListener("click",e.bind(this)),t.addEventListener(this.eventTouchend,e.bind(this))},window.fakeStorage={_data:{},setItem:function(t,e){return this._data[t]=String(e)},getItem:function(t){return this._data.hasOwnProperty(t)?this._data[t]:void 0},removeItem:function(t){return delete this._data[t]},clear:function(){return this._data={}}},LocalStorageManager.prototype.localStorageSupported=function(){try{var t=window.localStorage;return t.setItem("test","1"),t.removeItem("test"),!0}catch(t){return!1}},LocalStorageManager.prototype.getBestScore=function(){return this.storage.getItem(this.bestScoreKey)||0},LocalStorageManager.prototype.setBestScore=function(t){this.storage.setItem(this.bestScoreKey,t)},LocalStorageManager.prototype.getGameState=function(){var t=this.storage.getItem(this.gameStateKey);return t?JSON.parse(t):null},LocalStorageManager.prototype.setGameState=function(t){this.storage.setItem(this.gameStateKey,JSON.stringify(t))},LocalStorageManager.prototype.clearGameState=function(){this.storage.removeItem(this.gameStateKey)},Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(t){this.x=t.x,this.y=t.y},Tile.prototype.serialize=function(){return{position:{x:this.x,y:this.y},value:this.value}};